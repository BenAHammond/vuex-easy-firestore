!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vuex-easy-access"),require("is-what"),require("babel-runtime/helpers/typeof"),require("babel-runtime/helpers/toConsumableArray"),require("babel-runtime/regenerator"),require("babel-runtime/helpers/asyncToGenerator"),require("firebase/app"),require("firebase/firestore"),require("firebase/auth"),require("regenerator-runtime/runtime")):"function"==typeof define&&define.amd?define(["exports","vuex-easy-access","is-what","babel-runtime/helpers/typeof","babel-runtime/helpers/toConsumableArray","babel-runtime/regenerator","babel-runtime/helpers/asyncToGenerator","firebase/app","firebase/firestore","firebase/auth","regenerator-runtime/runtime"],t):t(e.Index={},e.vuexEasyAccess,e.isWhat,e._typeof,e._toConsumableArray,e._regeneratorRuntime,e._asyncToGenerator,e.Firebase)}(this,function(e,s,p,a,d,T,t,P){"use strict";a=a&&a.hasOwnProperty("default")?a.default:a,d=d&&d.hasOwnProperty("default")?d.default:d,T=T&&T.hasOwnProperty("default")?T.default:T,t=t&&t.hasOwnProperty("default")?t.default:t,P=P&&P.hasOwnProperty("default")?P.default:P;var u=function(e){return!(!(n=e)||"object"!=typeof n||(t=e,"[object RegExp]"===(r=Object.prototype.toString.call(t))||"[object Date]"===r||t.$$typeof===o));var t,r,n};var o="function"==typeof Symbol&&Symbol.for?Symbol.for("react.element"):60103;function l(e,t){return!1!==t.clone&&t.isMergeableObject(e)?h((r=e,Array.isArray(r)?[]:{}),e,t):e;var r}function f(e,t,r){return e.concat(t).map(function(e){return l(e,r)})}function h(e,t,r){(r=r||{}).arrayMerge=r.arrayMerge||f,r.isMergeableObject=r.isMergeableObject||u;var n,o,a,i,c=Array.isArray(t);return c===Array.isArray(e)?c?r.arrayMerge(e,t,r):(n=e,o=t,i={},(a=r).isMergeableObject(n)&&Object.keys(n).forEach(function(e){i[e]=l(n[e],a)}),Object.keys(o).forEach(function(e){a.isMergeableObject(o[e])&&n[e]?i[e]=h(n[e],o[e],a):i[e]=l(o[e],a)}),i):l(t,r)}h.all=function(e,r){if(!Array.isArray(e))throw new Error("first argument should be an array");return e.reduce(function(e,t){return h(e,t,r)},{})};var y=h;function g(e,t,r){return t}function r(e,t,r,n,o,a){e()}var v={moduleNameSpace:"firestore",docsStateProp:"",firestorePath:"",firestoreRefType:"collection",vuexUserPath:"",sync:{type:"2way",where:[],orderBy:[],defaultValues:{},added:r,modified:r,removed:r},fetch:{docLimit:50},insert:{checkCondition:null,fillables:[],guard:[]},patch:{checkCondition:null,fillables:[],guard:[]},delete:{checkCondition:null}},m={syncStack:{updates:{},deletions:[],inserts:[],debounceTimer:null},retrievedFetchRefs:[],nextFetchRef:null,patching:!1,doneFetching:!1,stopPatchingTimeout:null},S={resetSyncStack:function(e){e.syncStack={updates:{},deletions:[],inserts:[],debounceTimer:null}},INSERT_DOC:function(e,t){"doc"!==e.firestoreRefType.toLowerCase()&&this._vm.$set(e[e.docsStateProp],t.id,t)},PATCH_DOC:function(r,n){var o=this;if("doc"===r.firestoreRefType.toLowerCase())return r.docsStateProp?void(r[r.docsStateProp]=y(r[r.docsStateProp],n,{arrayMerge:g})):Object.keys(n).forEach(function(e){var t=void 0===r[e]?n[e]:p.isObject(r[e])&&p.isObject(n[e])?y(r[e],n[e],{arrayMerge:g}):n[e];o._vm.$set(r,e,t)});var e=void 0===r[r.docsStateProp][n.id]?n:p.isObject(r[r.docsStateProp][n.id])&&p.isObject(n)?y(r[r.docsStateProp][n.id],n,{arrayMerge:g}):n;this._vm.$set(r[r.docsStateProp],n.id,e)},DELETE_DOC:function(e,t){"doc"!==e.firestoreRefType.toLowerCase()&&this._vm.$delete(e[e.docsStateProp],t)}};function C(e){var t=void 0;if("object"!=(void 0===e?"undefined":a(e)))return e;if(!e)return e;if("[object Object]"!==Object.prototype.toString.call(e)||"[object Array]"!==Object.prototype.toString.call(e))return JSON.parse(JSON.stringify(e));if("[object Array]"===Object.prototype.toString.call(e)){t=[];for(var r=0,n=e.length;r<n;r++)t[r]=C(e[r]);return t}for(var o in t={},e)e.hasOwnProperty(o)&&(t[o]=C(e[o]));return t}function b(e,t){return y(t,e,{arrayMerge:g})}var n,E={patchDoc:function(e){var r=e.state,t=e.getters,n=(e.commit,e.dispatch),o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{ids:[],fields:[]},a=o.id,i=void 0===a?"":a,c=o.ids,s=void 0===c?[]:c,u=o.field,d=void 0===u?"":u,l=o.fields,f=void 0===l?[]:l;if(!p.isArray(s)||!p.isArray(f))return console.log("ids, fields need to be arrays");if(!p.isString(d))return console.log("field needs to be a string");i&&s.push(i),d&&f.push(d);var h=t.prepareForPatch(s,f);return Object.keys(h).forEach(function(e){var t=r.syncStack.updates[e]?y(r.syncStack.updates[e],h[e],{arrayMerge:g}):h[e];r.syncStack.updates[e]=t}),n("handleSyncStackDebounce")},deleteDoc:function(e){var t=e.state,r=e.getters,n=e.commit,o=e.dispatch,a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];p.isArray(a)||(a=[a]);var i=r.prepareForDeletion(a);if(n("SET_SYNCSTACK.DELETIONS",t.syncStack.deletions.concat(i)),t.syncStack.deletions.length)return o("handleSyncStackDebounce")},insertDoc:function(e){var t=e.state,r=e.getters,n=e.commit,o=e.dispatch,a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];p.isArray(a)||(a=[a]);var i=r.prepareForInsert(a);return n("SET_SYNCSTACK.INSERTS",t.syncStack.inserts.concat(i)),o("handleSyncStackDebounce")},handleSyncStackDebounce:function(e){var o,a,t=e.state,r=e.commit,n=e.dispatch;if(!e.getters.signedIn)return!1;if(!t.syncStack.debounceTimer){var i=(o=1e3,a=Date.now(),{done:new Promise(function(r,e){var n=setInterval(function(e){var t=Date.now();o<=t-a&&(clearInterval(n),r(!0))},10)}),refresh:function(){return a=Date.now()}});i.done.then(function(e){return n("batchSync")}),r("SET_SYNCSTACK.DEBOUNCETIMER",i)}t.syncStack.debounceTimer.refresh()},batchSync:(n=t(T.mark(function e(t){var o,a,i,r,n,c,s,u,d,l,f,h,p,y,g,v,m=t.getters,S=t.commit,b=t.dispatch,E=t.state;return T.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o=m.collectionMode,a=m.dbRef,i=P.firestore().batch(),r=0,n=C(E.syncStack.updates),500<=(c=Object.keys(n).map(function(e){return{id:e,fields:n[e]}})).length?(r=500,s=c.slice(0,500),u=c.slice(500,-1),E.syncStack.updates=u.reduce(function(e,t){return delete(e[t.id]=t).id,e},{}),c=s):(E.syncStack.updates={},r=c.length),c.forEach(function(e){var t=e.id,r=o?a.doc(t):a,n=e.fields;i.update(r,n)}),d=C(E.syncStack.deletions),500<=r?d=[]:(l=500-r,f=d.slice(0,l),h=d.slice(l,-1),S("SET_SYNCSTACK.DELETIONS",h),r+=f.length,d=f),d.forEach(function(e){var t=a.doc(e);i.delete(t)}),p=C(E.syncStack.inserts),500<=r?p=[]:(y=500-r,g=p.slice(0,y),v=p.slice(y,-1),S("SET_SYNCSTACK.INSERTS",v),r+=g.length,p=g),p.forEach(function(e){var t=m.dbRef.doc(e.id);i.set(t,e)}),b("_startPatching"),S("SET_SYNCSTACK.DEBOUNCETIMER",null),e.next=18,i.commit().then(function(e){console.log("[batchSync] RESOLVED:",e,"\n        updates: ",Object.keys(c).length?c:{},"\n        deletions: ",d.length?d:[],"\n        inserts: ",p.length?p:[]),Object.keys(E.syncStack.updates).length+E.syncStack.deletions.length+E.syncStack.inserts.length&&b("batchSync"),b("_stopPatching")}).catch(function(e){throw S("SET_PATCHING","error"),S("SET_SYNCSTACK.DEBOUNCETIMER",null),e});case 18:case"end":return e.stop()}},e,this)})),function(e){return n.apply(this,arguments)}),fetch:function(e){var i=e.state,r=e.getters,c=e.commit,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{whereFilters:[],orderBy:[]},n=t.whereFilters,s=void 0===n?[]:n,o=t.orderBy,u=void 0===o?[]:o;return new Promise(function(o,t){if(console.log("[fetch] starting"),!r.signedIn)return o();if(i.doneFetching)return console.log("done fetching"),o("fetchedAll");var e,a=void 0;i.nextFetchRef?a=i.nextFetchRef:(a=r.dbRef,s.forEach(function(e){var t;a=(t=a).where.apply(t,d(e))}),u.length&&(a=(e=a).orderBy.apply(e,d(u))));if(a=a.limit(i.fetch.docLimit),i.retrievedFetchRefs.includes(a))return console.log("Already retrieved this part."),o();a.get().then(function(e){var t=e.docs;if(0===t.length)return c("SET_DONEFETCHING",!0),o("fetchedAll");t.length<i.fetch.docLimit&&c("SET_DONEFETCHING",!0),c("PUSH_RETRIEVEDFETCHREFS",a),o(e);var r=t[t.length-1],n=a.startAfter(r);c("SET_NEXTFETCHREF",n)}).catch(function(e){return console.log(e),t(e)})})},serverUpdate:function(e,t){var r=e.commit,n=t.change,o=t.id,a=t.doc,i=void 0===a?{}:a;switch(i.id=o,n){case"added":r("INSERT_DOC",i);break;case"removed":r("DELETE_DOC",o);break;default:r("PATCH_DOC",i)}},openDBChannel:function(e){var t,r=e.getters,i=e.state,o=e.commit,c=e.dispatch,a=r.collectionMode,s=r.dbRef;"doc"!==i.firestoreRefType.toLowerCase()&&(i.sync.where.forEach(function(e){var t;s=(t=s).where.apply(t,d(e))}),i.sync.orderBy.length&&(s=(t=s).orderBy.apply(t,d(i.sync.orderBy))));function u(e,t,r,n){function o(){return c("serverUpdate",{change:e,id:t,doc:r})}e=e?e.type:"modified";var a=i.sync[e];a?a(o,this,t,r,n):o()}return new Promise(function(n,t){s.onSnapshot(function(e){var t=e.metadata.hasPendingWrites?"local":"server";if(!a){var r=b(e.data(),i.sync.defaultValues);return"local"===t||u(null,null,r,t),n()}e.docChanges().forEach(function(e){return("local"!==t||"modified"!==e.type&&"removed"!==e.type)&&u(e,e.doc.id,"added"===e.type?b(e.doc.data(),i.sync.defaultValues):e.doc.data(),t),n()})},function(e){return o("SET_PATCHING","error"),t(e)})})},set:function(e,t){e.commit;var r=e.dispatch,n=e.getters,o=e.state;if(t)return n.collectionMode?t.id&&o[o.docsStateProp][t.id]?r("patch",t):r("insert",t):r("patch",t)},insert:function(e,t){var r=e.commit,n=e.dispatch,o=e.getters;if(t)return t.id||(t.id=o.dbRef.doc().id),r("INSERT_DOC",t),n("insertDoc",t)},patch:function(e,t){var r=e.commit,n=(e.state,e.dispatch),o=e.getters;if(t&&(t.id||!o.collectionMode))return r("PATCH_DOC",t),n("patchDoc",{id:t.id,fields:Object.keys(t)})},delete:function(e,t){var r=e.commit,n=e.dispatch;e.getters;return r("DELETE_DOC",t),n("deleteDoc",t)},_stopPatching:function(e){var t=e.state,r=e.commit;t.stopPatchingTimeout&&clearTimeout(t.stopPatchingTimeout),t.stopPatchingTimeout=setTimeout(function(e){r("SET_PATCHING",!1)},300)},_startPatching:function(e){var t=e.state,r=e.commit;t.stopPatchingTimeout&&clearTimeout(t.stopPatchingTimeout),r("SET_PATCHING",!0)}};function O(t){var r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];return p.isObject(t)&&(r.length&&Object.keys(t).forEach(function(e){r.includes(e)||delete t[e]}),e.forEach(function(e){delete t[e]})),t}var D={signedIn:function(e,t,r,n){return null!==s.getDeepRef(r,e.vuexUserPath)},dbRef:function(e,t,r,n){if(!t.signedIn)return!1;var o=P.auth().currentUser.uid,a=e.firestorePath.replace("{userId}",o);return"collection"===e.firestoreRefType.toLowerCase()?P.firestore().collection(a):P.firestore().doc(a)},storeRef:function(e,t,r){var n=e.docsStateProp?e.moduleNameSpace+"/"+e.docsStateProp:e.moduleNameSpace;return s.getDeepRef(r,n)},collectionMode:function(e,t,r){return"collection"===e.firestoreRefType.toLowerCase()},prepareForPatch:function(i,c,e,t){return function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],a=c.collectionMode;return a||e.push("singleDoc"),e.reduce(function(e,t){var r=i.patch.checkCondition;if(r&&!r(t,o,c.storeRef))return e;var n={};return o.length?o.forEach(function(e){n[e]=a?c.storeRef[t][e]:c.storeRef[e]}):n=O(n=C(a?c.storeRef[t]:c.storeRef),i.patch.fillables,i.patch.guard),n.updated_at=P.firestore.FieldValue.serverTimestamp(),e[t]=n,e},{})}},prepareForDeletion:function(n,o,e,t){return function(){return(0<arguments.length&&void 0!==arguments[0]?arguments[0]:[]).reduce(function(e,t){var r=n.delete.checkCondition;return r&&!r(t,o.storeRef)||e.push(t),e},[])}},prepareForInsert:function(n,o,e,a){return function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];return(e=C(e)).reduce(function(e,t){var r=n.insert.checkCondition;return r&&!r(t,o.storeRef)||((t=O(t,n.insert.fillables,n.insert.guard)).created_at=P.firestore.FieldValue.serverTimestamp(),t.created_by=a["user/id"],e.push(t)),e},[])}}};var R={state:null,mutations:null,actions:null,getters:null};function i(e){var t=y(R,e,{arrayMerge:g});if(r=t,["firestorePath","vuexUserPath"].forEach(function(e){return console.error("Missing "+e+" from your config!"),!1}),/(\.|\/)/.test(r.docsStateProp)?(console.error("docsStateProp must only include letters from [a-z]"),0):!/\./.test(r.moduleNameSpace)||(console.error("moduleNameSpace must only include letters from [a-z] and forward slashes '/'"),0)){var r,n=t.state,o=t.mutations,a=t.actions,i=t.getters;delete t.state,delete t.mutations,delete t.actions,delete t.getters;var c={};return t.docsStateProp&&(c[t.docsStateProp]={}),{namespaced:!0,state:y.all([m,v,n,t,c],{arrayMerge:g}),mutations:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=arguments[1],r=s.defaultMutations(t);return Object.assign({},r,S,e)}(o,y(m,n)),actions:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return Object.assign({},E,e)}(a),getters:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return Object.assign({},D,e)}(i)}}}e.default=function(e){return function(r){p.isArray(e)||(e=[e]),e.forEach(function(e){var t=s.getKeysFromPath(e.moduleNameSpace);r.registerModule(t,i(e))}),r.setDoc=function(e,t){return r.dispatch(e+"/setDoc",t)},r.insert=function(e,t){return r.dispatch(e+"/insert",t)},r.patch=function(e,t){return r.dispatch(e+"/patch",t)},r.delete=function(e,t){return r.dispatch(e+"/delete",t)}}},Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=index.min.js.map
