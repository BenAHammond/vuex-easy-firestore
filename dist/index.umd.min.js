!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("is-what"),require("vuex-easy-access"),require("firebase/app"),require("firebase/firestore"),require("firebase/auth")):"function"==typeof define&&define.amd?define(["is-what","vuex-easy-access","firebase/app","firebase/firestore","firebase/auth"],t):e.VuexEasyFirestore=t(e.isWhat,e.vuexEasyAccess,e.Firebase)}(this,function(e,t,n){"use strict";n=n&&n.hasOwnProperty("default")?n.default:n;var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},o=require("nanoclone").default;function i(e){for(var t=[],n=0;n<e.length;++n)t.push(e[n]);return t}var a=[{name:"primitive",is:function(e){var t=void 0===e?"undefined":r(e);return"number"===t||"string"===t||"boolean"===t},default:"default",merge:{default:function(e,t,n){return n}}},{name:"object",is:function(e){return null!==e&&"object"===(void 0===e?"undefined":r(e))},default:"deep",merge:{deep:function(e,t,n){var r={},c={a:Object.keys(t),b:Object.keys(n)};return c.a.concat(c.b).forEach(function(c){r[c]=e(t[c],n[c])}),r}}},{name:"array",is:function(e){return Array.isArray(e)},default:"replace",merge:{merge:function(e,t,n){for(var r=[],c=0;c<Math.max(t.length,n.length);++c)r.push(e(t[c],n[c]));return r},replace:function(e,t,n){return o(n)},concat:function(e,t,n){return[].concat(t).concat(n)}}}];function s(e){function t(n,r){if(void 0===r)return o(n);var c=function(e,t){for(var n=a.length-1;n>=0;--n){var r=a[n];if(r.is(e)&&r.is(t))return r;if(r.is(e)||r.is(t))break}return null}(n,r);if(!c)return o(r);var i=e.strategy[c.name]||c.default;return c.merge[i](t,n,r)}return e||(e={}),e={strategy:e.strategy||{}},function(){return i(arguments).reduceRight(function(e,n){return t(n,e)})}}function u(){for(var t=arguments.length;t>0;t--){var n=arguments.length<=t-1?void 0:arguments[t-1];if(!e.isObject(n))return console.error("trying to merge a non-object: ",n),n}return function(){var e=i(arguments);return 1===e.length?s(e[0]):s().apply(null,e)}.apply(void 0,arguments)}var f={firestorePath:"",firestoreRefType:"",moduleName:"",statePropName:"",sync:{where:[],orderBy:[],fillables:[],guard:[],insertHook:function(e,t,n){return e(t)},patchHook:function(e,t,n){return e(t)},deleteHook:function(e,t,n){return e(t)}},serverChange:{defaultValues:{},addedHook:function(e,t,n,r,c,o){return e(t)},modifiedHook:function(e,t,n,r,c,o){return e(t)},removedHook:function(e,t,n,r,c,o){return e(t)}},fetch:{docLimit:50},state:{},getters:{},mutations:{},actions:{}},d={_sync:{signedIn:!1,patching:!1,syncStack:{updates:{},deletions:[],inserts:[],debounceTimer:null},fetched:[],stopPatchingTimeout:null}},l={resetSyncStack:function(e){e._sync.syncStack={updates:{},deletions:[],inserts:[],debounceTimer:null}},INSERT_DOC:function(e,t){"doc"!==e._conf.firestoreRefType.toLowerCase()&&this._vm.$set(e[e._conf.statePropName],t.id,t)},PATCH_DOC:function(t,n){var r=this;if("doc"===t._conf.firestoreRefType.toLowerCase())return t._conf.statePropName?void(t[t._conf.statePropName]=u(t[t._conf.statePropName],n)):Object.keys(n).forEach(function(c){var o=void 0===t[c]?n[c]:e.isObject(t[c])&&e.isObject(n[c])?u(t[c],n[c]):n[c];r._vm.$set(t,c,o)});var c=void 0===t[t._conf.statePropName][n.id]?n:e.isObject(t[t._conf.statePropName][n.id])&&e.isObject(n)?u(t[t._conf.statePropName][n.id],n):n;this._vm.$set(t[t._conf.statePropName],n.id,c)},DELETE_DOC:function(e,t){"doc"!==e._conf.firestoreRefType.toLowerCase()&&this._vm.$delete(e[e._conf.statePropName],t)}};function h(e){var t=void 0;if("object"!=(void 0===e?"undefined":r(e)))return e;if(!e)return e;if("[object Object]"!==Object.prototype.toString.call(e)||"[object Array]"!==Object.prototype.toString.call(e))return JSON.parse(JSON.stringify(e));if("[object Array]"===Object.prototype.toString.call(e)){t=[];for(var n=0,c=e.length;n<c;n++)t[n]=h(e[n]);return t}for(var o in t={},e)e.hasOwnProperty(o)&&(t[o]=h(e[o]));return t}function y(e,t){return u(t,e)}function p(t){return function t(n,r,c){return e.isObject(n)&&Object.keys(n).length?Object.keys(n).reduce(function(e,o){var i=(r?r+".":"")+o,a=t(n[o],i,c);return Object.assign(e,a)},{}):r?(c[r]=n,c):n}(t,null,{})}var m={patchDoc:function(t){var n=t.state,r=t.getters,c=(t.commit,t.dispatch),o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{ids:[],doc:{}},i=o.id,a=void 0===i?"":i,s=o.ids,f=void 0===s?[]:s,d=o.doc;if(!e.isArray(f))return console.log("ids needs to be an array");a&&f.push(a),d.id&&delete d.id;var l=r.prepareForPatch(f,d);return Object.keys(l).forEach(function(e){var t=n._sync.syncStack.updates[e]?u(n._sync.syncStack.updates[e],l[e]):l[e];n._sync.syncStack.updates[e]=t}),c("handleSyncStackDebounce")},deleteDoc:function(t){var n=t.state,r=t.getters,c=(t.commit,t.dispatch),o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];e.isArray(o)||(o=[o]);var i=r.prepareForDeletion(o),a=n._sync.syncStack.deletions.concat(i);if(n._sync.syncStack.deletions=a,n._sync.syncStack.deletions.length)return c("handleSyncStackDebounce")},insertDoc:function(t){var n=t.state,r=t.getters,c=(t.commit,t.dispatch),o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];e.isArray(o)||(o=[o]);var i=r.prepareForInsert(o),a=n._sync.syncStack.inserts.concat(i);return n._sync.syncStack.inserts=a,c("handleSyncStackDebounce")},handleSyncStackDebounce:function(e){var t,n,r=e.state,c=(e.commit,e.dispatch);if(!e.getters.signedIn)return!1;if(!r._sync.syncStack.debounceTimer){var o=(t=1e3,n=Date.now(),{done:new Promise(function(e,r){var c=setInterval(function(r){Date.now()-n>=t&&(clearInterval(c),e(!0))},10)}),refresh:function(){return n=Date.now()}});o.done.then(function(e){return c("batchSync")}),r._sync.syncStack.debounceTimer=o}r._sync.syncStack.debounceTimer.refresh()},batchSync:function(e){var t=e.getters,r=(e.commit,e.dispatch),c=e.state,o=t.collectionMode,i=t.dbRef,a=n.firestore().batch(),s=0,u=h(c._sync.syncStack.updates),f=Object.keys(u).map(function(e){return{id:e,fields:u[e]}});if(f.length>=500){s=500;var d=f.slice(0,500),l=f.slice(500,-1);c._sync.syncStack.updates=l.reduce(function(e,t){return e[t.id]=t,delete t.id,e},{}),f=d}else c._sync.syncStack.updates={},s=f.length;f.forEach(function(e){var t=e.id,n=o?i.doc(t):i,r=p(e.fields);console.log("fields â†’ ",r),a.update(n,r)});var y=h(c._sync.syncStack.deletions);if(s>=500)y=[];else{var m=500-s,v=y.slice(0,m),g=y.slice(m,-1);c._sync.syncStack.deletions=g,s+=v.length,y=v}y.forEach(function(e){var t=i.doc(e);a.delete(t)});var _=h(c._sync.syncStack.inserts);if(s>=500)_=[];else{var b=500-s,k=_.slice(0,b),S=_.slice(b,-1);c._sync.syncStack.inserts=S,s+=k.length,_=k}return _.forEach(function(e){var n=t.dbRef.doc(e.id);a.set(n,e)}),r("_startPatching"),c._sync.syncStack.debounceTimer=null,new Promise(function(e,t){a.commit().then(function(t){return console.log("[batchSync] RESOLVED:",t,"\n          updates: ",Object.keys(f).length?f:{},"\n          deletions: ",y.length?y:[],"\n          inserts: ",_.length?_:[]),Object.keys(c._sync.syncStack.updates).length+c._sync.syncStack.deletions.length+c._sync.syncStack.inserts.length&&r("batchSync"),r("_stopPatching"),e()}).catch(function(e){return c._sync.patching="error",c._sync.syncStack.debounceTimer=null,t()})})},fetch:function(e){var t=e.state,n=e.getters,r=(e.commit,e.dispatch,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{whereFilters:[],orderBy:[]}),o=r.whereFilters,i=void 0===o?[]:o,a=r.orderBy,s=void 0===a?[]:a;return new Promise(function(e,r){if(console.log("[fetch] starting"),!n.signedIn)return e();var o=JSON.stringify({whereFilters:i,orderBy:s});if(!t._sync.fetched[o]){var a,u=n.dbRef;if(i.forEach(function(e){var t;u=(t=u).where.apply(t,c(e))}),s.length)u=(a=u).orderBy.apply(a,c(s));t._sync.fetched[o]={ref:u,done:!1,retrievedFetchRefs:[],nextFetchRef:null}}var f=t._sync.fetched[o];if(f.done)return console.log("done fetching"),e("fetchedAll");var d=t._sync.fetched[o].ref;if(f.nextFetchRef&&(d=t._sync.fetched[o].nextFetchRef),d=d.limit(t._conf.fetch.docLimit),f.retrievedFetchRefs.includes(d))return console.log("Already retrieved this part."),e();d.get().then(function(n){var r=n.docs;if(0===r.length)return t._sync.fetched[o].done=!0,void e("fetchedAll");r.length<t._conf.fetch.docLimit&&(t._sync.fetched[o].done=!0),t._sync.fetched[o].retrievedFetchRefs.push(fetchRef),e(n);var c=r[r.length-1],i=d.startAfter(c);t._sync.fetched[o].nextFetchRef=i}).catch(function(e){return console.log(e),r(e)})})},serverUpdate:function(e,t){var n=e.commit,r=t.change,c=t.id,o=t.doc,i=void 0===o?{}:o;switch(i.id=c,r){case"added":n("INSERT_DOC",i);break;case"removed":n("DELETE_DOC",c);break;default:n("PATCH_DOC",i)}},openDBChannel:function(e){var t=e.getters,r=e.state,o=(e.commit,e.dispatch);n.auth().currentUser&&(r._sync.signedIn=!0);var i,a=t.collectionMode,s=t.dbRef;"doc"!==r._conf.firestoreRefType.toLowerCase()&&(r._conf.sync.where.forEach(function(e){var t;s=(t=s).where.apply(t,c(e))}),r._conf.sync.orderBy.length&&(s=(i=s).orderBy.apply(i,c(r._conf.sync.orderBy))));function u(e,t,n,c){function i(n){return o("serverUpdate",{change:e,id:t,doc:n})}e=e?e.type:"modified";var a=r._conf.serverChange[e+"Hook"];a?a(i,n,t,this,c,e):i(n)}return new Promise(function(e,t){s.onSnapshot(function(t){var n=t.metadata.hasPendingWrites?"local":"server";if(!a){var c=y(t.data(),r._conf.serverChange.defaultValues);return"local"===n?e():(u(null,null,c,n),e())}t.docChanges().forEach(function(t){if("local"===n&&("modified"===t.type||"removed"===t.type))return e();var c=t.doc.id,o="added"===t.type?y(t.doc.data(),r._conf.serverChange.defaultValues):t.doc.data();return u(t,c,o,n),e()})},function(e){return r._sync.patching="error",t(e)})})},set:function(e,t){e.commit;var n=e.dispatch,r=e.getters,c=e.state;if(t)return r.collectionMode?t.id&&c[c._conf.statePropName][t.id]?n("patch",t):n("insert",t):n("patch",t)},insert:function(e,t){var n=e.state,r=e.getters,c=e.commit,o=e.dispatch;if(t)return t.id||(t.id=r.dbRef.doc().id),n._conf.sync.insertHook?n._conf.sync.insertHook(i,t,this):i(t);function i(e){return c("INSERT_DOC",e),o("insertDoc",e)}},patch:function(e,t){var n=e.state,r=e.getters,c=e.commit,o=e.dispatch;if(t&&(t.id||!r.collectionMode))return n._conf.sync.patchHook?n._conf.sync.patchHook(i,t,this):i(t);function i(e){return c("PATCH_DOC",e),o("patchDoc",{id:e.id,doc:e})}},patchBatch:function(e,t){var n=e.state,r=(e.getters,e.commit),c=e.dispatch,o=t.doc,i=t.ids,a=void 0===i?[]:i;if(o)return n._conf.sync.patchHook?n._conf.sync.patchHook(s,o,this):s(o);function s(e){return r("PATCH_DOC",e),c("patchDoc",{ids:a,doc:e})}},delete:function(e,t){var n=e.state,r=(e.getters,e.commit),c=e.dispatch;function o(e){return r("DELETE_DOC",e),c("deleteDoc",e)}return n._conf.sync.deleteHook?n._conf.sync.deleteHook(o,t,this):o(t)},_stopPatching:function(e){var t=e.state;e.commit;t._sync.stopPatchingTimeout&&clearTimeout(t._sync.stopPatchingTimeout),t._sync.stopPatchingTimeout=setTimeout(function(e){t._sync.patching=!1},300)},_startPatching:function(e){var t=e.state;e.commit;t._sync.stopPatchingTimeout&&clearTimeout(t._sync.stopPatchingTimeout),t._sync.patching=!0}};function v(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];return e.isObject(t)?(n.length&&Object.keys(t).forEach(function(e){n.includes(e)||delete t[e]}),r.forEach(function(e){delete t[e]}),t):t}var g={signedIn:function(e,t,n,r){return e._sync.signedIn},dbRef:function(e,t,r,c){if(!t.signedIn)return!1;if(!n.auth().currentUser)return!1;var o=n.auth().currentUser.uid,i=e._conf.firestorePath.replace("{userId}",o);return"collection"===e._conf.firestoreRefType.toLowerCase()?n.firestore().collection(i):n.firestore().doc(i)},storeRef:function(e,n,r){var c=e._conf.statePropName?e._conf.moduleName+"/"+e._conf.statePropName:e._conf.moduleName;return t.getDeepRef(r,c)},collectionMode:function(e,t,n){return"collection"===e._conf.firestoreRefType.toLowerCase()},prepareForPatch:function(e,t,r,c){return function(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=t.collectionMode;return o||r.push("singleDoc"),r.reduce(function(r,i){var a={};return(a=v(a=h(a=Object.keys(c).length?c:o?t.storeRef[i]:t.storeRef),e._conf.sync.fillables,e._conf.sync.guard)).updated_at=n.firestore.FieldValue.serverTimestamp(),r[i]=a,r},{})}},prepareForDeletion:function(e,t,n,r){return function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).reduce(function(e,t){return e.push(t),e},[])}},prepareForInsert:function(e,t,r,c){return function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return(t=h(t)).reduce(function(t,r){return(r=v(r,e._conf.sync.fillables,e._conf.sync.guard)).created_at=n.firestore.FieldValue.serverTimestamp(),r.created_by=c["user/id"],t.push(r),t},[])}}};function _(e){var n=u(f,e);if(r=n,["firestorePath","moduleName"].forEach(function(e){if(!r[e])return console.error("Missing "+e+" from your config!"),!1}),/(\.|\/)/.test(r.statePropName)?(console.error("statePropName must only include letters from [a-z]"),0):!/\./.test(r.moduleName)||(console.error("moduleName must only include letters from [a-z] and forward slashes '/'"),0)){var r,c=n.state,o=n.mutations,i=n.actions,a=n.getters;delete n.state,delete n.mutations,delete n.actions,delete n.getters;var s={};return n.statePropName&&(s[n.statePropName]={}),{namespaced:!0,state:u(d,c,s,{_conf:n}),mutations:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1],r=t.defaultMutations(n);return Object.assign({},r,l,e)}(o,u(d,c)),actions:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.assign({},m,e)}(i),getters:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.assign({},g,e)}(a)}}}return function(n){return function(r){e.isArray(n)||(n=[n]),n.forEach(function(e){var n=t.getKeysFromPath(e.moduleName);r.registerModule(n,_(e))}),r.setDoc=function(e,t){return r.dispatch(e+"/setDoc",t)},r.insert=function(e,t){return r.dispatch(e+"/insert",t)},r.patch=function(e,t){return r.dispatch(e+"/patch",t)},r.patchBatch=function(e,t){return r.dispatch(e+"/patchBatch",t)},r.delete=function(e,t){return r.dispatch(e+"/delete",t)}}}});
//# sourceMappingURL=index.umd.min.js.map
