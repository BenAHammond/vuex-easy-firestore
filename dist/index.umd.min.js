!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("vuex-easy-access"),require("is-what"),require("firebase/app"),require("firebase/firestore"),require("firebase/auth")):"function"==typeof define&&define.amd?define(["vuex-easy-access","is-what","firebase/app","firebase/firestore","firebase/auth"],t):e.VuexEasyFirestore=t(e.vuexEasyAccess,e.isWhat,e.Firebase)}(this,function(e,t,r){"use strict";r=r&&r.hasOwnProperty("default")?r.default:r;var n=function(e){return function(e){return!!e&&"object"==typeof e}(e)&&!function(e){var t=Object.prototype.toString.call(e);return"[object RegExp]"===t||"[object Date]"===t||function(e){return e.$$typeof===o}(e)}(e)};var o="function"==typeof Symbol&&Symbol.for?Symbol.for("react.element"):60103;function i(e,t){return!1!==t.clone&&t.isMergeableObject(e)?a((r=e,Array.isArray(r)?[]:{}),e,t):e;var r}function c(e,t,r){return e.concat(t).map(function(e){return i(e,r)})}function a(e,t,r){(r=r||{}).arrayMerge=r.arrayMerge||c,r.isMergeableObject=r.isMergeableObject||n;var o=Array.isArray(t);return o===Array.isArray(e)?o?r.arrayMerge(e,t,r):function(e,t,r){var n={};return r.isMergeableObject(e)&&Object.keys(e).forEach(function(t){n[t]=i(e[t],r)}),Object.keys(t).forEach(function(o){r.isMergeableObject(t[o])&&e[o]?n[o]=a(e[o],t[o],r):n[o]=i(t[o],r)}),n}(e,t,r):i(t,r)}a.all=function(e,t){if(!Array.isArray(e))throw new Error("first argument should be an array");return e.reduce(function(e,r){return a(e,r,t)},{})};var s=a;function u(e,t,r){return t}function d(e,t,r){return r&&r.arrayOverwrite?s(e,t,{arrayMerge:u}):s(e,t)}function f(e,t,r,n,o,i){e()}d.all=function(e,t){return t&&t.arrayOverwrite?s.all(e,{arrayMerge:u}):s.all(e)};var l={moduleNameSpace:"firestore",docsStateProp:"",firestorePath:"",firestoreRefType:"collection",vuexUserPath:"",sync:{type:"2way",where:[],orderBy:[],defaultValues:{},added:f,modified:f,removed:f},fetch:{docLimit:50},insert:{checkCondition:null,fillables:[],guard:[]},patch:{checkCondition:null,fillables:[],guard:[]},delete:{checkCondition:null}},h={syncStack:{updates:{},deletions:[],inserts:[],debounceTimer:null},retrievedFetchRefs:[],nextFetchRef:null,patching:!1,doneFetching:!1,stopPatchingTimeout:null},p={resetSyncStack:function(e){e.syncStack={updates:{},deletions:[],inserts:[],debounceTimer:null}},INSERT_DOC:function(e,t){"doc"!==e.firestoreRefType.toLowerCase()&&this._vm.$set(e[e.docsStateProp],t.id,t)},PATCH_DOC:function(e,r){var n=this;if("doc"===e.firestoreRefType.toLowerCase())return e.docsStateProp?void(e[e.docsStateProp]=d(e[e.docsStateProp],r,{arrayOverwrite:!0})):Object.keys(r).forEach(function(o){var i=void 0===e[o]?r[o]:t.isObject(e[o])&&t.isObject(r[o])?d(e[o],r[o],{arrayOverwrite:!0}):r[o];n._vm.$set(e,o,i)});var o=void 0===e[e.docsStateProp][r.id]?r:t.isObject(e[e.docsStateProp][r.id])&&t.isObject(r)?d(e[e.docsStateProp][r.id],r,{arrayOverwrite:!0}):r;this._vm.$set(e[e.docsStateProp],r.id,o)},DELETE_DOC:function(e,t){"doc"!==e.firestoreRefType.toLowerCase()&&this._vm.$delete(e[e.docsStateProp],t)}};var y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},v=function(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)};function g(e){var t=void 0;if("object"!=(void 0===e?"undefined":y(e)))return e;if(!e)return e;if("[object Object]"!==Object.prototype.toString.call(e)||"[object Array]"!==Object.prototype.toString.call(e))return JSON.parse(JSON.stringify(e));if("[object Array]"===Object.prototype.toString.call(e)){t=[];for(var r=0,n=e.length;r<n;r++)t[r]=g(e[r]);return t}for(var o in t={},e)e.hasOwnProperty(o)&&(t[o]=g(e[o]));return t}function S(e,t){return d(t,e,{arrayOverwrite:!0})}var m={patchDoc:function(e){var r=e.state,n=e.getters,o=(e.commit,e.dispatch),i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{ids:[],fields:[]},c=i.id,a=void 0===c?"":c,s=i.ids,u=void 0===s?[]:s,f=i.field,l=void 0===f?"":f,h=i.fields,p=void 0===h?[]:h;if(!t.isArray(u)||!t.isArray(p))return console.log("ids, fields need to be arrays");if(!t.isString(l))return console.log("field needs to be a string");a&&u.push(a),l&&p.push(l);var y=n.prepareForPatch(u,p);return Object.keys(y).forEach(function(e){var t=r.syncStack.updates[e]?d(r.syncStack.updates[e],y[e],{arrayOverwrite:!0}):y[e];r.syncStack.updates[e]=t}),o("handleSyncStackDebounce")},deleteDoc:function(e){var r=e.state,n=e.getters,o=e.commit,i=e.dispatch,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];t.isArray(c)||(c=[c]);var a=n.prepareForDeletion(c);if(o("SET_SYNCSTACK.DELETIONS",r.syncStack.deletions.concat(a)),r.syncStack.deletions.length)return i("handleSyncStackDebounce")},insertDoc:function(e){var r=e.state,n=e.getters,o=e.commit,i=e.dispatch,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];t.isArray(c)||(c=[c]);var a=n.prepareForInsert(c);return o("SET_SYNCSTACK.INSERTS",r.syncStack.inserts.concat(a)),i("handleSyncStackDebounce")},handleSyncStackDebounce:function(e){var t,r,n=e.state,o=e.commit,i=e.dispatch;if(!e.getters.signedIn)return!1;if(!n.syncStack.debounceTimer){var c=(t=1e3,r=Date.now(),{done:new Promise(function(e,n){var o=setInterval(function(n){Date.now()-r>=t&&(clearInterval(o),e(!0))},10)}),refresh:function(){return r=Date.now()}});c.done.then(function(e){return i("batchSync")}),o("SET_SYNCSTACK.DEBOUNCETIMER",c)}n.syncStack.debounceTimer.refresh()},batchSync:function(e){var t=e.getters,n=e.commit,o=e.dispatch,i=e.state,c=t.collectionMode,a=t.dbRef,s=r.firestore().batch(),u=0,d=g(i.syncStack.updates),f=Object.keys(d).map(function(e){return{id:e,fields:d[e]}});if(f.length>=500){u=500;var l=f.slice(0,500),h=f.slice(500,-1);i.syncStack.updates=h.reduce(function(e,t){return e[t.id]=t,delete t.id,e},{}),f=l}else i.syncStack.updates={},u=f.length;f.forEach(function(e){var t=e.id,r=c?a.doc(t):a,n=e.fields;s.update(r,n)});var p=g(i.syncStack.deletions);if(u>=500)p=[];else{var y=500-u,v=p.slice(0,y),S=p.slice(y,-1);n("SET_SYNCSTACK.DELETIONS",S),u+=v.length,p=v}p.forEach(function(e){var t=a.doc(e);s.delete(t)});var m=g(i.syncStack.inserts);if(u>=500)m=[];else{var b=500-u,E=m.slice(0,b),T=m.slice(b,-1);n("SET_SYNCSTACK.INSERTS",T),u+=E.length,m=E}return m.forEach(function(e){var r=t.dbRef.doc(e.id);s.set(r,e)}),o("_startPatching"),n("SET_SYNCSTACK.DEBOUNCETIMER",null),new Promise(function(e,t){s.commit().then(function(t){return console.log("[batchSync] RESOLVED:",t,"\n          updates: ",Object.keys(f).length?f:{},"\n          deletions: ",p.length?p:[],"\n          inserts: ",m.length?m:[]),Object.keys(i.syncStack.updates).length+i.syncStack.deletions.length+i.syncStack.inserts.length&&o("batchSync"),o("_stopPatching"),e()}).catch(function(e){return n("SET_PATCHING","error"),n("SET_SYNCSTACK.DEBOUNCETIMER",null),t()})})},fetch:function(e){var t=e.state,r=e.getters,n=e.commit,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{whereFilters:[],orderBy:[]},i=o.whereFilters,c=void 0===i?[]:i,a=o.orderBy,s=void 0===a?[]:a;return new Promise(function(e,o){if(console.log("[fetch] starting"),!r.signedIn)return e();if(t.doneFetching)return console.log("done fetching"),e("fetchedAll");var i,a=void 0;t.nextFetchRef?a=t.nextFetchRef:(a=r.dbRef,c.forEach(function(e){var t;a=(t=a).where.apply(t,v(e))}),s.length&&(a=(i=a).orderBy.apply(i,v(s))));if(a=a.limit(t.fetch.docLimit),t.retrievedFetchRefs.includes(a))return console.log("Already retrieved this part."),e();a.get().then(function(r){var o=r.docs;if(0===o.length)return n("SET_DONEFETCHING",!0),e("fetchedAll");o.length<t.fetch.docLimit&&n("SET_DONEFETCHING",!0),n("PUSH_RETRIEVEDFETCHREFS",a),e(r);var i=o[o.length-1],c=a.startAfter(i);n("SET_NEXTFETCHREF",c)}).catch(function(e){return console.log(e),o(e)})})},serverUpdate:function(e,t){var r=e.commit,n=t.change,o=t.id,i=t.doc,c=void 0===i?{}:i;switch(c.id=o,n){case"added":r("INSERT_DOC",c);break;case"removed":r("DELETE_DOC",o);break;default:r("PATCH_DOC",c)}},openDBChannel:function(e){var t,r=e.getters,n=e.state,o=e.commit,i=e.dispatch,c=r.collectionMode,a=r.dbRef;"doc"!==n.firestoreRefType.toLowerCase()&&(n.sync.where.forEach(function(e){var t;a=(t=a).where.apply(t,v(e))}),n.sync.orderBy.length&&(a=(t=a).orderBy.apply(t,v(n.sync.orderBy))));function s(e,t,r,o){function c(){return i("serverUpdate",{change:e,id:t,doc:r})}e=e?e.type:"modified";var a=n.sync[e];a?a(c,this,t,r,o):c()}return new Promise(function(e,t){a.onSnapshot(function(t){var r=t.metadata.hasPendingWrites?"local":"server";if(!c){var o=S(t.data(),n.sync.defaultValues);return"local"===r?e():(s(null,null,o,r),e())}t.docChanges().forEach(function(t){if("local"===r&&("modified"===t.type||"removed"===t.type))return e();var o=t.doc.id,i="added"===t.type?S(t.doc.data(),n.sync.defaultValues):t.doc.data();return s(t,o,i,r),e()})},function(e){return o("SET_PATCHING","error"),t(e)})})},set:function(e,t){e.commit;var r=e.dispatch,n=e.getters,o=e.state;if(t)return n.collectionMode?t.id&&o[o.docsStateProp][t.id]?r("patch",t):r("insert",t):r("patch",t)},insert:function(e,t){var r=e.commit,n=e.dispatch,o=e.getters;if(t)return t.id||(t.id=o.dbRef.doc().id),r("INSERT_DOC",t),n("insertDoc",t)},patch:function(e,t){var r=e.commit,n=(e.state,e.dispatch),o=e.getters;if(t&&(t.id||!o.collectionMode))return r("PATCH_DOC",t),n("patchDoc",{id:t.id,fields:Object.keys(t)})},delete:function(e,t){var r=e.commit,n=e.dispatch;e.getters;return r("DELETE_DOC",t),n("deleteDoc",t)},_stopPatching:function(e){var t=e.state,r=e.commit;t.stopPatchingTimeout&&clearTimeout(t.stopPatchingTimeout),t.stopPatchingTimeout=setTimeout(function(e){r("SET_PATCHING",!1)},300)},_startPatching:function(e){var t=e.state,r=e.commit;t.stopPatchingTimeout&&clearTimeout(t.stopPatchingTimeout),r("SET_PATCHING",!0)}};function b(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];return t.isObject(e)?(r.length&&Object.keys(e).forEach(function(t){r.includes(t)||delete e[t]}),n.forEach(function(t){delete e[t]}),e):e}var E={signedIn:function(t,r,n,o){return null!==e.getDeepRef(n,t.vuexUserPath)},dbRef:function(e,t,n,o){if(!t.signedIn)return!1;var i=r.auth().currentUser.uid,c=e.firestorePath.replace("{userId}",i);return"collection"===e.firestoreRefType.toLowerCase()?r.firestore().collection(c):r.firestore().doc(c)},storeRef:function(t,r,n){var o=t.docsStateProp?t.moduleNameSpace+"/"+t.docsStateProp:t.moduleNameSpace;return e.getDeepRef(n,o)},collectionMode:function(e,t,r){return"collection"===e.firestoreRefType.toLowerCase()},prepareForPatch:function(e,t,n,o){return function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=t.collectionMode;return i||n.push("singleDoc"),n.reduce(function(n,c){var a=e.patch.checkCondition;if(a&&!a(c,o,t.storeRef))return n;var s={};return o.length?o.forEach(function(e){s[e]=i?t.storeRef[c][e]:t.storeRef[e]}):s=b(s=g(i?t.storeRef[c]:t.storeRef),e.patch.fillables,e.patch.guard),s.updated_at=r.firestore.FieldValue.serverTimestamp(),n[c]=s,n},{})}},prepareForDeletion:function(e,t,r,n){return function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).reduce(function(r,n){var o=e.delete.checkCondition;return o&&!o(n,t.storeRef)?r:(r.push(n),r)},[])}},prepareForInsert:function(e,t,n,o){return function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return(n=g(n)).reduce(function(n,i){var c=e.insert.checkCondition;return c&&!c(i,t.storeRef)?n:((i=b(i,e.insert.fillables,e.insert.guard)).created_at=r.firestore.FieldValue.serverTimestamp(),i.created_by=o["user/id"],n.push(i),n)},[])}}};var T={state:null,mutations:null,actions:null,getters:null};function O(t){var r=d(T,t,{arrayOverwrite:!0});if(n=r,["firestorePath","vuexUserPath"].forEach(function(e){return console.error("Missing "+e+" from your config!"),!1}),/(\.|\/)/.test(n.docsStateProp)?(console.error("docsStateProp must only include letters from [a-z]"),0):!/\./.test(n.moduleNameSpace)||(console.error("moduleNameSpace must only include letters from [a-z] and forward slashes '/'"),0)){var n,o=r.state,i=r.mutations,c=r.actions,a=r.getters;delete r.state,delete r.mutations,delete r.actions,delete r.getters;var s={};return r.docsStateProp&&(s[r.docsStateProp]={}),{namespaced:!0,state:d.all([h,l,o,r,s],{arrayOverwrite:!0}),mutations:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments[1],n=e.defaultMutations(r);return Object.assign({},n,p,t)}(i,d(h,o)),actions:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.assign({},m,e)}(c),getters:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.assign({},E,e)}(a)}}}return function(r){return function(n){t.isArray(r)||(r=[r]),r.forEach(function(t){var r=e.getKeysFromPath(t.moduleNameSpace);n.registerModule(r,O(t))}),n.setDoc=function(e,t){return n.dispatch(e+"/setDoc",t)},n.insert=function(e,t){return n.dispatch(e+"/insert",t)},n.patch=function(e,t){return n.dispatch(e+"/patch",t)},n.delete=function(e,t){return n.dispatch(e+"/delete",t)}}}});
//# sourceMappingURL=index.umd.min.js.map
