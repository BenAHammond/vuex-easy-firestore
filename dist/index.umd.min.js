!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("is-what"),require("firebase/app"),require("firebase/firestore"),require("firebase/auth"),require("vuex-easy-access")):"function"==typeof define&&define.amd?define(["is-what","firebase/app","firebase/firestore","firebase/auth","vuex-easy-access"],t):e.VuexEasyFirestore=t(e.isWhat,e.Firebase,null,null,e.vuexEasyAccess)}(this,function(e,t,n,r,c){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},s=require("nanoclone").default;function a(e){for(var t=[],n=0;n<e.length;++n)t.push(e[n]);return t}var u=[{name:"primitive",is:function(e){var t=void 0===e?"undefined":o(e);return"number"===t||"string"===t||"boolean"===t},default:"default",merge:{default:function(e,t,n){return n}}},{name:"object",is:function(e){return null!==e&&"object"===(void 0===e?"undefined":o(e))},default:"deep",merge:{deep:function(e,t,n){var r={},c={a:Object.keys(t),b:Object.keys(n)};return c.a.concat(c.b).forEach(function(c){r[c]=e(t[c],n[c])}),r}}},{name:"array",is:function(e){return Array.isArray(e)},default:"replace",merge:{merge:function(e,t,n){for(var r=[],c=0;c<Math.max(t.length,n.length);++c)r.push(e(t[c],n[c]));return r},replace:function(e,t,n){return s(n)},concat:function(e,t,n){return[].concat(t).concat(n)}}}];function f(e){function t(n,r){if(void 0===r)return s(n);var c=function(e,t){for(var n=u.length-1;n>=0;--n){var r=u[n];if(r.is(e)&&r.is(t))return r;if(r.is(e)||r.is(t))break}return null}(n,r);if(!c)return s(r);var o=e.strategy[c.name]||c.default;return c.merge[o](t,n,r)}return e||(e={}),e={strategy:e.strategy||{}},function(){return a(arguments).reduceRight(function(e,n){return t(n,e)})}}function d(){for(var t=arguments.length;t>0;t--){var n=arguments.length<=t-1?void 0:arguments[t-1];if(!e.isObject(n))return console.error("trying to merge a non-object: ",n),n}return function(){var e=a(arguments);return 1===e.length?f(e[0]):f().apply(null,e)}.apply(void 0,arguments)}var l={firestorePath:"",firestoreRefType:"",moduleName:"",statePropName:"",sync:{where:[],orderBy:[],fillables:[],guard:[],insertHook:function(e,t,n){return e(t)},patchHook:function(e,t,n){return e(t)},deleteHook:function(e,t,n){return e(t)}},serverChange:{defaultValues:{},addedHook:function(e,t,n,r,c,o){return e(t)},modifiedHook:function(e,t,n,r,c,o){return e(t)},removedHook:function(e,t,n,r,c,o){return e(t)}},fetch:{docLimit:50},state:{},getters:{},mutations:{},actions:{}},h={_sync:{signedIn:!1,patching:!1,syncStack:{updates:{},deletions:[],inserts:[],debounceTimer:null},fetched:[],stopPatchingTimeout:null}},y={resetSyncStack:function(e){e._sync.syncStack={updates:{},deletions:[],inserts:[],debounceTimer:null}},INSERT_DOC:function(e,t){"doc"!==e._conf.firestoreRefType.toLowerCase()&&(e._conf.statePropName?this._vm.$set(e[e._conf.statePropName],t.id,t):this._vm.$set(e,t.id,t))},PATCH_DOC:function(t,n){var r=this;if("doc"===t._conf.firestoreRefType.toLowerCase())return t._conf.statePropName?void(t[t._conf.statePropName]=d(t[t._conf.statePropName],n)):Object.keys(n).forEach(function(c){var o=void 0!==t[c]&&e.isObject(t[c])&&e.isObject(n[c])?d(t[c],n[c]):n[c];r._vm.$set(t,c,o)});var c=t._conf.statePropName?t[t._conf.statePropName][n.id]:t[n.id],o=void 0!==c&&e.isObject(c)&&e.isObject(n)?d(c,n):n;t._conf.statePropName?this._vm.$set(t[t._conf.statePropName],n.id,o):this._vm.$set(t,n.id,o)},DELETE_DOC:function(e,t){"doc"!==e._conf.firestoreRefType.toLowerCase()&&(e._conf.statePropName?this._vm.$delete(e[e._conf.statePropName],t):this._vm.$delete(e,t))}};function p(e){var t=void 0;if("object"!=(void 0===e?"undefined":o(e)))return e;if(!e)return e;if("[object Object]"!==Object.prototype.toString.call(e)||"[object Array]"!==Object.prototype.toString.call(e))return JSON.parse(JSON.stringify(e));if("[object Array]"===Object.prototype.toString.call(e)){t=[];for(var n=0,r=e.length;n<r;n++)t[n]=p(e[n]);return t}for(var c in t={},e)e.hasOwnProperty(c)&&(t[c]=p(e[c]));return t}function m(e,t){return d(t,e)}function v(t){return function t(n,r,c){return e.isObject(n)&&Object.keys(n).length?Object.keys(n).reduce(function(e,o){var i=(r?r+".":"")+o,s=t(n[o],i,c);return Object.assign(e,s)},{}):r?(c[r]=n,c):n}(t,null,{})}var g={patchDoc:function(t){var n=t.state,r=t.getters,c=(t.commit,t.dispatch),o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{ids:[],doc:{}},i=o.id,s=void 0===i?"":i,a=o.ids,u=void 0===a?[]:a,f=o.doc;if(!e.isArray(u))return console.log("ids needs to be an array");s&&u.push(s),f.id&&delete f.id;var l=r.prepareForPatch(u,f);return Object.keys(l).forEach(function(e){var t=n._sync.syncStack.updates[e]?d(n._sync.syncStack.updates[e],l[e]):l[e];n._sync.syncStack.updates[e]=t}),c("handleSyncStackDebounce")},deleteDoc:function(t){var n=t.state,r=t.getters,c=(t.commit,t.dispatch),o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];e.isArray(o)||(o=[o]);var i=r.prepareForDeletion(o),s=n._sync.syncStack.deletions.concat(i);if(n._sync.syncStack.deletions=s,n._sync.syncStack.deletions.length)return c("handleSyncStackDebounce")},insertDoc:function(t){var n=t.state,r=t.getters,c=(t.commit,t.dispatch),o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];e.isArray(o)||(o=[o]);var i=r.prepareForInsert(o),s=n._sync.syncStack.inserts.concat(i);return n._sync.syncStack.inserts=s,c("handleSyncStackDebounce")},handleSyncStackDebounce:function(e){var t,n,r=e.state,c=(e.commit,e.dispatch);if(!e.getters.signedIn)return!1;if(!r._sync.syncStack.debounceTimer){var o=(t=1e3,n=Date.now(),{done:new Promise(function(e,r){var c=setInterval(function(r){Date.now()-n>=t&&(clearInterval(c),e(!0))},10)}),refresh:function(){return n=Date.now()}});o.done.then(function(e){return c("batchSync")}),r._sync.syncStack.debounceTimer=o}r._sync.syncStack.debounceTimer.refresh()},batchSync:function(e){var n=e.getters,r=(e.commit,e.dispatch),c=e.state,o=n.collectionMode,i=n.dbRef,s=t.firestore().batch(),a=0,u=p(c._sync.syncStack.updates),f=Object.keys(u).map(function(e){return{id:e,fields:u[e]}});if(f.length>=500){a=500;var d=f.slice(0,500),l=f.slice(500,-1);c._sync.syncStack.updates=l.reduce(function(e,t){return e[t.id]=t,delete t.id,e},{}),f=d}else c._sync.syncStack.updates={},a=f.length;f.forEach(function(e){var t=e.id,n=o?i.doc(t):i,r=v(e.fields);console.log("fields â†’ ",r),s.update(n,r)});var h=p(c._sync.syncStack.deletions);if(a>=500)h=[];else{var y=500-a,m=h.slice(0,y),g=h.slice(y,-1);c._sync.syncStack.deletions=g,a+=m.length,h=m}h.forEach(function(e){var t=i.doc(e);s.delete(t)});var _=p(c._sync.syncStack.inserts);if(a>=500)_=[];else{var b=500-a,k=_.slice(0,b),S=_.slice(b,-1);c._sync.syncStack.inserts=S,a+=k.length,_=k}return _.forEach(function(e){var t=n.dbRef.doc(e.id);s.set(t,e)}),r("_startPatching"),c._sync.syncStack.debounceTimer=null,new Promise(function(e,t){s.commit().then(function(t){return console.log("[batchSync] RESOLVED:",t,"\n          updates: ",Object.keys(f).length?f:{},"\n          deletions: ",h.length?h:[],"\n          inserts: ",_.length?_:[]),Object.keys(c._sync.syncStack.updates).length+c._sync.syncStack.deletions.length+c._sync.syncStack.inserts.length&&r("batchSync"),r("_stopPatching"),e()}).catch(function(e){return c._sync.patching="error",c._sync.syncStack.debounceTimer=null,t()})})},fetch:function(e){var t=e.state,n=e.getters,r=(e.commit,e.dispatch,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{whereFilters:[],orderBy:[]}),c=r.whereFilters,o=void 0===c?[]:c,s=r.orderBy,a=void 0===s?[]:s;return new Promise(function(e,r){if(console.log("[fetch] starting"),!n.signedIn)return e();var c=JSON.stringify({whereFilters:o,orderBy:a});if(!t._sync.fetched[c]){var s,u=n.dbRef;if(o.forEach(function(e){var t;u=(t=u).where.apply(t,i(e))}),a.length)u=(s=u).orderBy.apply(s,i(a));t._sync.fetched[c]={ref:u,done:!1,retrievedFetchRefs:[],nextFetchRef:null}}var f=t._sync.fetched[c];if(f.done)return console.log("done fetching"),e("fetchedAll");var d=t._sync.fetched[c].ref;if(f.nextFetchRef&&(d=t._sync.fetched[c].nextFetchRef),d=d.limit(t._conf.fetch.docLimit),f.retrievedFetchRefs.includes(d))return console.log("Already retrieved this part."),e();d.get().then(function(n){var r=n.docs;if(0===r.length)return t._sync.fetched[c].done=!0,void e("fetchedAll");r.length<t._conf.fetch.docLimit&&(t._sync.fetched[c].done=!0),t._sync.fetched[c].retrievedFetchRefs.push(fetchRef),e(n);var o=r[r.length-1],i=d.startAfter(o);t._sync.fetched[c].nextFetchRef=i}).catch(function(e){return console.log(e),r(e)})})},serverUpdate:function(e,t){var n=e.commit,r=t.change,c=t.id,o=t.doc,i=void 0===o?{}:o;switch(i.id=c,r){case"added":n("INSERT_DOC",i);break;case"removed":n("DELETE_DOC",c);break;default:n("PATCH_DOC",i)}},openDBChannel:function(e){var n=e.getters,r=e.state,c=(e.commit,e.dispatch),o=this;t.auth().currentUser&&(r._sync.signedIn=!0);var s,a=n.collectionMode,u=n.dbRef;"doc"!==r._conf.firestoreRefType.toLowerCase()&&(r._conf.sync.where.forEach(function(e){var t;u=(t=u).where.apply(t,i(e))}),r._conf.sync.orderBy.length&&(u=(s=u).orderBy.apply(s,i(r._conf.sync.orderBy))));function f(e,t,n,i){function s(n){return c("serverUpdate",{change:e,id:t,doc:n})}e=e?e.type:"modified";var a=r._conf.serverChange[e+"Hook"];a?a(s,n,t,o,i,e):s(n)}return new Promise(function(e,t){u.onSnapshot(function(t){var n=t.metadata.hasPendingWrites?"local":"server";if(!a){var c=m(t.data(),r._conf.serverChange.defaultValues);return"local"===n?e():(f(null,null,c,n),e())}t.docChanges().forEach(function(t){if("local"===n&&("modified"===t.type||"removed"===t.type))return e();var c=t.doc.id,o="added"===t.type?m(t.doc.data(),r._conf.serverChange.defaultValues):t.doc.data();return f(t,c,o,n),e()})},function(e){return r._sync.patching="error",t(e)})})},set:function(e,t){e.commit;var n=e.dispatch,r=e.getters,c=e.state;if(t)return r.collectionMode&&(!t.id||!c._conf.statePropName&&!c[t.id]||c._conf.statePropName&&!c[c._conf.statePropName][t.id])?n("insert",t):n("patch",t)},insert:function(e,t){var n=e.state,r=e.getters,c=e.commit,o=e.dispatch;if(t)return t.id||(t.id=r.dbRef.doc().id),n._conf.sync.insertHook?n._conf.sync.insertHook(i,t,this):i(t);function i(e){return c("INSERT_DOC",e),o("insertDoc",e)}},patch:function(e,t){var n=e.state,r=e.getters,c=e.commit,o=e.dispatch;if(t&&(t.id||!r.collectionMode))return n._conf.sync.patchHook?n._conf.sync.patchHook(i,t,this):i(t);function i(e){return c("PATCH_DOC",e),o("patchDoc",{id:e.id,doc:e})}},patchBatch:function(e,t){var n=e.state,r=(e.getters,e.commit),c=e.dispatch,o=t.doc,i=t.ids,s=void 0===i?[]:i;if(o)return n._conf.sync.patchHook?n._conf.sync.patchHook(a,o,this):a(o);function a(e){return r("PATCH_DOC",e),c("patchDoc",{ids:s,doc:e})}},delete:function(e,t){var n=e.state,r=(e.getters,e.commit),c=e.dispatch;function o(e){return r("DELETE_DOC",e),c("deleteDoc",e)}return n._conf.sync.deleteHook?n._conf.sync.deleteHook(o,t,this):o(t)},_stopPatching:function(e){var t=e.state;e.commit;t._sync.stopPatchingTimeout&&clearTimeout(t._sync.stopPatchingTimeout),t._sync.stopPatchingTimeout=setTimeout(function(e){t._sync.patching=!1},300)},_startPatching:function(e){var t=e.state;e.commit;t._sync.stopPatchingTimeout&&clearTimeout(t._sync.stopPatchingTimeout),t._sync.patching=!0}};function _(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];return e.isObject(t)?(n.length&&Object.keys(t).forEach(function(e){n.includes(e)||delete t[e]}),r.forEach(function(e){delete t[e]}),t):t}var b={signedIn:function(e,t,n,r){return e._sync.signedIn},dbRef:function(e,n,r,c){if(!n.signedIn)return!1;if(!t.auth().currentUser)return!1;var o=t.auth().currentUser.uid,i=e._conf.firestorePath.replace("{userId}",o);return"collection"===e._conf.firestoreRefType.toLowerCase()?t.firestore().collection(i):t.firestore().doc(i)},storeRef:function(e,t,n){var r=e._conf.statePropName?e._conf.moduleName+"/"+e._conf.statePropName:e._conf.moduleName;return c.getDeepRef(n,r)},collectionMode:function(e,t,n){return"collection"===e._conf.firestoreRefType.toLowerCase()},prepareForPatch:function(e,n,r,c){return function(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=n.collectionMode;return o||r.push("singleDoc"),r.reduce(function(r,i){var s={};return(s=_(s=p(s=Object.keys(c).length?c:o?n.storeRef[i]:n.storeRef),e._conf.sync.fillables,e._conf.sync.guard)).updated_at=t.firestore.FieldValue.serverTimestamp(),r[i]=s,r},{})}},prepareForDeletion:function(e,t,n,r){return function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).reduce(function(e,t){return e.push(t),e},[])}},prepareForInsert:function(e,n,r,c){return function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return(n=p(n)).reduce(function(n,r){return(r=_(r,e._conf.sync.fillables,e._conf.sync.guard)).created_at=t.firestore.FieldValue.serverTimestamp(),r.created_by=c["user/id"],n.push(r),n},[])}}};function k(e){var t=d(l,e);if(n=t,["firestorePath","moduleName"].forEach(function(e){if(!n[e])return console.error("Missing "+e+" from your config!"),!1}),/(\.|\/)/.test(n.statePropName)?(console.error("statePropName must only include letters from [a-z]"),0):!/\./.test(n.moduleName)||(console.error("moduleName must only include letters from [a-z] and forward slashes '/'"),0)){var n,r=t.state,c=t.mutations,o=t.actions,i=t.getters;delete t.state,delete t.mutations,delete t.actions,delete t.getters;var s={};return t.statePropName&&(s[t.statePropName]={}),{namespaced:!0,state:d(h,r,s,{_conf:t}),mutations:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.assign({},y,e)}(c,d(h,r)),actions:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.assign({},g,e)}(o),getters:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.assign({},b,e)}(i)}}}return function(t){return function(n){e.isArray(t)||(t=[t]),t.forEach(function(e){var t=c.getKeysFromPath(e.moduleName);n.registerModule(t,k(e))}),n.setDoc=function(e,t){return n.dispatch(e+"/setDoc",t)},n.insert=function(e,t){return n.dispatch(e+"/insert",t)},n.patch=function(e,t){return n.dispatch(e+"/patch",t)},n.patchBatch=function(e,t){return n.dispatch(e+"/patchBatch",t)},n.delete=function(e,t){return n.dispatch(e+"/delete",t)}}}});
//# sourceMappingURL=index.umd.min.js.map
