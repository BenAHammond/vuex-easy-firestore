"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var isWhat=require("is-what"),vuexEasyAccess=require("vuex-easy-access"),Firebase=_interopDefault(require("firebase/app"));require("firebase/firestore"),require("firebase/auth");var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},nanoclone=require("nanoclone").default;function toArray$1(e){for(var t=[],n=0;n<e.length;++n)t.push(e[n]);return t}var types=[{name:"primitive",is:function(e){var t=void 0===e?"undefined":_typeof(e);return"number"===t||"string"===t||"boolean"===t},default:"default",merge:{default:function(e,t,n){return n}}},{name:"object",is:function(e){return null!==e&&"object"===(void 0===e?"undefined":_typeof(e))},default:"deep",merge:{deep:function(e,t,n){var r={},o={a:Object.keys(t),b:Object.keys(n)};return o.a.concat(o.b).forEach(function(o){r[o]=e(t[o],n[o])}),r}}},{name:"array",is:function(e){return Array.isArray(e)},default:"replace",merge:{merge:function(e,t,n){for(var r=[],o=0;o<Math.max(t.length,n.length);++o)r.push(e(t[o],n[o]));return r},replace:function(e,t,n){return nanoclone(n)},concat:function(e,t,n){return[].concat(t).concat(n)}}}];function merge(e){function t(n,r){if(void 0===r)return nanoclone(n);var o=function(e,t){for(var n=types.length-1;n>=0;--n){var r=types[n];if(r.is(e)&&r.is(t))return r;if(r.is(e)||r.is(t))break}return null}(n,r);if(!o)return nanoclone(r);var c=e.strategy[o.name]||o.default;return o.merge[c](t,n,r)}return e||(e={}),e={strategy:e.strategy||{}},function(){return toArray$1(arguments).reduceRight(function(e,n){return t(n,e)})}}function wrapper(){var e=toArray$1(arguments);return 1===e.length?merge(e[0]):merge().apply(null,e)}function merge$1(){for(var e=arguments.length;e>0;e--){var t=arguments.length<=e-1?void 0:arguments[e-1];if(!isWhat.isObject(t))return console.error("trying to merge a non-object: ",t),t}return wrapper.apply(void 0,arguments)}var defaultConfig={firestorePath:"",firestoreRefType:"",moduleName:"",statePropName:"",sync:{where:[],orderBy:[],fillables:[],guard:[],insertHook:function(e,t,n){return e(t)},patchHook:function(e,t,n){return e(t)},deleteHook:function(e,t,n){return e(t)}},serverChange:{defaultValues:{},addedHook:function(e,t,n,r,o,c){return e(t)},modifiedHook:function(e,t,n,r,o,c){return e(t)},removedHook:function(e,t,n,r,o,c){return e(t)}},fetch:{docLimit:50},state:{},getters:{},mutations:{},actions:{}},initialState={_sync:{signedIn:!1,patching:!1,syncStack:{updates:{},deletions:[],inserts:[],debounceTimer:null},fetched:[],stopPatchingTimeout:null}},mutations={resetSyncStack:function(e){e._sync.syncStack={updates:{},deletions:[],inserts:[],debounceTimer:null}},INSERT_DOC:function(e,t){"doc"!==e._conf.firestoreRefType.toLowerCase()&&(e._conf.statePropName?this._vm.$set(e[e._conf.statePropName],t.id,t):this._vm.$set(e,t.id,t))},PATCH_DOC:function(e,t){var n=this;if("doc"===e._conf.firestoreRefType.toLowerCase())return e._conf.statePropName?void(e[e._conf.statePropName]=merge$1(e[e._conf.statePropName],t)):Object.keys(t).forEach(function(r){var o=void 0!==e[r]&&isWhat.isObject(e[r])&&isWhat.isObject(t[r])?merge$1(e[r],t[r]):t[r];n._vm.$set(e,r,o)});var r=e._conf.statePropName?e[e._conf.statePropName][t.id]:e[t.id],o=void 0!==r&&isWhat.isObject(r)&&isWhat.isObject(t)?merge$1(r,t):t;e._conf.statePropName?this._vm.$set(e[e._conf.statePropName],t.id,o):this._vm.$set(e,t.id,o)},DELETE_DOC:function(e,t){"doc"!==e._conf.firestoreRefType.toLowerCase()&&(e._conf.statePropName?this._vm.$delete(e[e._conf.statePropName],t):this._vm.$delete(e,t))}};function iniMutations(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments[1],n=vuexEasyAccess.defaultMutations(t);return Object.assign({},n,mutations,e)}function copyObj(e){var t=void 0;if("object"!=(void 0===e?"undefined":_typeof(e)))return e;if(!e)return e;if("[object Object]"!==Object.prototype.toString.call(e)||"[object Array]"!==Object.prototype.toString.call(e))return JSON.parse(JSON.stringify(e));if("[object Array]"===Object.prototype.toString.call(e)){t=[];for(var n=0,r=e.length;n<r;n++)t[n]=copyObj(e[n]);return t}for(var o in t={},e)e.hasOwnProperty(o)&&(t[o]=copyObj(e[o]));return t}function setDefaultValues(e,t){return merge$1(t,e)}function startDebounce(e){var t=Date.now();return{done:new Promise(function(n,r){var o=setInterval(function(r){Date.now()-t>=e&&(clearInterval(o),n(!0))},10)}),refresh:function(){return t=Date.now()}}}function retrievePaths(e,t,n){return isWhat.isObject(e)&&Object.keys(e).length?Object.keys(e).reduce(function(r,o){var c=(t?t+".":"")+o,i=retrievePaths(e[o],c,n);return Object.assign(r,i)},{}):t?(n[t]=e,n):e}function flattenToPaths(e){return retrievePaths(e,null,{})}var actions={patchDoc:function(e){var t=e.state,n=e.getters,r=(e.commit,e.dispatch),o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{ids:[],doc:{}},c=o.id,i=void 0===c?"":c,a=o.ids,s=void 0===a?[]:a,u=o.doc;if(!isWhat.isArray(s))return console.log("ids needs to be an array");i&&s.push(i),u.id&&delete u.id;var f=n.prepareForPatch(s,u);return Object.keys(f).forEach(function(e){var n=t._sync.syncStack.updates[e]?merge$1(t._sync.syncStack.updates[e],f[e]):f[e];t._sync.syncStack.updates[e]=n}),r("handleSyncStackDebounce")},deleteDoc:function(e){var t=e.state,n=e.getters,r=(e.commit,e.dispatch),o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];isWhat.isArray(o)||(o=[o]);var c=n.prepareForDeletion(o),i=t._sync.syncStack.deletions.concat(c);if(t._sync.syncStack.deletions=i,t._sync.syncStack.deletions.length)return r("handleSyncStackDebounce")},insertDoc:function(e){var t=e.state,n=e.getters,r=(e.commit,e.dispatch),o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];isWhat.isArray(o)||(o=[o]);var c=n.prepareForInsert(o),i=t._sync.syncStack.inserts.concat(c);return t._sync.syncStack.inserts=i,r("handleSyncStackDebounce")},handleSyncStackDebounce:function(e){var t=e.state,n=(e.commit,e.dispatch);if(!e.getters.signedIn)return!1;if(!t._sync.syncStack.debounceTimer){var r=startDebounce(1e3);r.done.then(function(e){return n("batchSync")}),t._sync.syncStack.debounceTimer=r}t._sync.syncStack.debounceTimer.refresh()},batchSync:function(e){var t=e.getters,n=(e.commit,e.dispatch),r=e.state,o=t.collectionMode,c=t.dbRef,i=Firebase.firestore().batch(),a=0,s=copyObj(r._sync.syncStack.updates),u=Object.keys(s).map(function(e){return{id:e,fields:s[e]}});if(u.length>=500){a=500;var f=u.slice(0,500),d=u.slice(500,-1);r._sync.syncStack.updates=d.reduce(function(e,t){return e[t.id]=t,delete t.id,e},{}),u=f}else r._sync.syncStack.updates={},a=u.length;u.forEach(function(e){var t=e.id,n=o?c.doc(t):c,r=flattenToPaths(e.fields);console.log("fields â†’ ",r),i.update(n,r)});var l=copyObj(r._sync.syncStack.deletions);if(a>=500)l=[];else{var h=500-a,y=l.slice(0,h),p=l.slice(h,-1);r._sync.syncStack.deletions=p,a+=y.length,l=y}l.forEach(function(e){var t=c.doc(e);i.delete(t)});var m=copyObj(r._sync.syncStack.inserts);if(a>=500)m=[];else{var v=500-a,g=m.slice(0,v),_=m.slice(v,-1);r._sync.syncStack.inserts=_,a+=g.length,m=g}return m.forEach(function(e){var n=t.dbRef.doc(e.id);i.set(n,e)}),n("_startPatching"),r._sync.syncStack.debounceTimer=null,new Promise(function(e,t){i.commit().then(function(t){return console.log("[batchSync] RESOLVED:",t,"\n          updates: ",Object.keys(u).length?u:{},"\n          deletions: ",l.length?l:[],"\n          inserts: ",m.length?m:[]),Object.keys(r._sync.syncStack.updates).length+r._sync.syncStack.deletions.length+r._sync.syncStack.inserts.length&&n("batchSync"),n("_stopPatching"),e()}).catch(function(e){return r._sync.patching="error",r._sync.syncStack.debounceTimer=null,t()})})},fetch:function(e){var t=e.state,n=e.getters,r=(e.commit,e.dispatch,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{whereFilters:[],orderBy:[]}),o=r.whereFilters,c=void 0===o?[]:o,i=r.orderBy,a=void 0===i?[]:i;return new Promise(function(e,r){if(console.log("[fetch] starting"),!n.signedIn)return e();var o=JSON.stringify({whereFilters:c,orderBy:a});if(!t._sync.fetched[o]){var i,s=n.dbRef;if(c.forEach(function(e){var t;s=(t=s).where.apply(t,toConsumableArray(e))}),a.length)s=(i=s).orderBy.apply(i,toConsumableArray(a));t._sync.fetched[o]={ref:s,done:!1,retrievedFetchRefs:[],nextFetchRef:null}}var u=t._sync.fetched[o];if(u.done)return console.log("done fetching"),e("fetchedAll");var f=t._sync.fetched[o].ref;if(u.nextFetchRef&&(f=t._sync.fetched[o].nextFetchRef),f=f.limit(t._conf.fetch.docLimit),u.retrievedFetchRefs.includes(f))return console.log("Already retrieved this part."),e();f.get().then(function(n){var r=n.docs;if(0===r.length)return t._sync.fetched[o].done=!0,void e("fetchedAll");r.length<t._conf.fetch.docLimit&&(t._sync.fetched[o].done=!0),t._sync.fetched[o].retrievedFetchRefs.push(fetchRef),e(n);var c=r[r.length-1],i=f.startAfter(c);t._sync.fetched[o].nextFetchRef=i}).catch(function(e){return console.log(e),r(e)})})},serverUpdate:function(e,t){var n=e.commit,r=t.change,o=t.id,c=t.doc,i=void 0===c?{}:c;switch(i.id=o,r){case"added":n("INSERT_DOC",i);break;case"removed":n("DELETE_DOC",o);break;default:n("PATCH_DOC",i)}},openDBChannel:function(e){var t=e.getters,n=e.state,r=(e.commit,e.dispatch),o=this;Firebase.auth().currentUser&&(n._sync.signedIn=!0);var c,i=t.collectionMode,a=t.dbRef;"doc"!==n._conf.firestoreRefType.toLowerCase()&&(n._conf.sync.where.forEach(function(e){var t;a=(t=a).where.apply(t,toConsumableArray(e))}),n._conf.sync.orderBy.length&&(a=(c=a).orderBy.apply(c,toConsumableArray(n._conf.sync.orderBy))));function s(e,t,c,i){function a(n){return r("serverUpdate",{change:e,id:t,doc:n})}e=e?e.type:"modified";var s=n._conf.serverChange[e+"Hook"];s?s(a,c,t,o,i,e):a(c)}return new Promise(function(e,t){a.onSnapshot(function(t){var r=t.metadata.hasPendingWrites?"local":"server";if(!i){var o=setDefaultValues(t.data(),n._conf.serverChange.defaultValues);return"local"===r?e():(s(null,null,o,r),e())}t.docChanges().forEach(function(t){if("local"===r&&("modified"===t.type||"removed"===t.type))return e();var o=t.doc.id,c="added"===t.type?setDefaultValues(t.doc.data(),n._conf.serverChange.defaultValues):t.doc.data();return s(t,o,c,r),e()})},function(e){return n._sync.patching="error",t(e)})})},set:function(e,t){e.commit;var n=e.dispatch,r=e.getters,o=e.state;if(t)return r.collectionMode&&(!t.id||!o._conf.statePropName&&!o[t.id]||o._conf.statePropName&&!o[o._conf.statePropName][t.id])?n("insert",t):n("patch",t)},insert:function(e,t){var n=e.state,r=e.getters,o=e.commit,c=e.dispatch;if(t)return t.id||(t.id=r.dbRef.doc().id),n._conf.sync.insertHook?n._conf.sync.insertHook(i,t,this):i(t);function i(e){return o("INSERT_DOC",e),c("insertDoc",e)}},patch:function(e,t){var n=e.state,r=e.getters,o=e.commit,c=e.dispatch;if(t&&(t.id||!r.collectionMode))return n._conf.sync.patchHook?n._conf.sync.patchHook(i,t,this):i(t);function i(e){return o("PATCH_DOC",e),c("patchDoc",{id:e.id,doc:e})}},patchBatch:function(e,t){var n=e.state,r=(e.getters,e.commit),o=e.dispatch,c=t.doc,i=t.ids,a=void 0===i?[]:i;if(c)return n._conf.sync.patchHook?n._conf.sync.patchHook(s,c,this):s(c);function s(e){return r("PATCH_DOC",e),o("patchDoc",{ids:a,doc:e})}},delete:function(e,t){var n=e.state,r=(e.getters,e.commit),o=e.dispatch;function c(e){return r("DELETE_DOC",e),o("deleteDoc",e)}return n._conf.sync.deleteHook?n._conf.sync.deleteHook(c,t,this):c(t)},_stopPatching:function(e){var t=e.state;e.commit;t._sync.stopPatchingTimeout&&clearTimeout(t._sync.stopPatchingTimeout),t._sync.stopPatchingTimeout=setTimeout(function(e){t._sync.patching=!1},300)},_startPatching:function(e){var t=e.state;e.commit;t._sync.stopPatchingTimeout&&clearTimeout(t._sync.stopPatchingTimeout),t._sync.patching=!0}};function iniActions(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.assign({},actions,e)}function checkFillables(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];return isWhat.isObject(e)?(t.length&&Object.keys(e).forEach(function(n){t.includes(n)||delete e[n]}),n.forEach(function(t){delete e[t]}),e):e}var getters={signedIn:function(e,t,n,r){return e._sync.signedIn},dbRef:function(e,t,n,r){if(!t.signedIn)return!1;if(!Firebase.auth().currentUser)return!1;var o=Firebase.auth().currentUser.uid,c=e._conf.firestorePath.replace("{userId}",o);return"collection"===e._conf.firestoreRefType.toLowerCase()?Firebase.firestore().collection(c):Firebase.firestore().doc(c)},storeRef:function(e,t,n){var r=e._conf.statePropName?e._conf.moduleName+"/"+e._conf.statePropName:e._conf.moduleName;return vuexEasyAccess.getDeepRef(n,r)},collectionMode:function(e,t,n){return"collection"===e._conf.firestoreRefType.toLowerCase()},prepareForPatch:function(e,t,n,r){return function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=t.collectionMode;return o||n.push("singleDoc"),n.reduce(function(n,c){var i={};return(i=checkFillables(i=copyObj(i=Object.keys(r).length?r:o?t.storeRef[c]:t.storeRef),e._conf.sync.fillables,e._conf.sync.guard)).updated_at=Firebase.firestore.FieldValue.serverTimestamp(),n[c]=i,n},{})}},prepareForDeletion:function(e,t,n,r){return function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).reduce(function(e,t){return e.push(t),e},[])}},prepareForInsert:function(e,t,n,r){return function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return(t=copyObj(t)).reduce(function(t,n){return(n=checkFillables(n,e._conf.sync.fillables,e._conf.sync.guard)).created_at=Firebase.firestore.FieldValue.serverTimestamp(),n.created_by=r["user/id"],t.push(n),t},[])}}};function iniGetters(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.assign({},getters,e)}function errorCheck(e){return["firestorePath","moduleName"].forEach(function(t){if(!e[t])return console.error("Missing "+t+" from your config!"),!1}),/(\.|\/)/.test(e.statePropName)?(console.error("statePropName must only include letters from [a-z]"),!1):!/\./.test(e.moduleName)||(console.error("moduleName must only include letters from [a-z] and forward slashes '/'"),!1)}function iniModule(e){var t=merge$1(defaultConfig,e);if(errorCheck(t)){var n=t.state,r=t.mutations,o=t.actions,c=t.getters;delete t.state,delete t.mutations,delete t.actions,delete t.getters;var i={};return t.statePropName&&(i[t.statePropName]={}),{namespaced:!0,state:merge$1(initialState,n,i,{_conf:t}),mutations:iniMutations(r,merge$1(initialState,n)),actions:iniActions(o),getters:iniGetters(c)}}}function createEasyFirestore(e){return function(t){isWhat.isArray(e)||(e=[e]),e.forEach(function(e){var n=vuexEasyAccess.getKeysFromPath(e.moduleName);t.registerModule(n,iniModule(e))}),t.setDoc=function(e,n){return t.dispatch(e+"/setDoc",n)},t.insert=function(e,n){return t.dispatch(e+"/insert",n)},t.patch=function(e,n){return t.dispatch(e+"/patch",n)},t.patchBatch=function(e,n){return t.dispatch(e+"/patchBatch",n)},t.delete=function(e,n){return t.dispatch(e+"/delete",n)}}}module.exports=createEasyFirestore;
//# sourceMappingURL=index.cjs.min.js.map
