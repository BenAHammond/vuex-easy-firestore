"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var vuexEasyAccess=require("vuex-easy-access"),isWhat=require("is-what"),Firebase=_interopDefault(require("firebase/app"));require("firebase/firestore"),require("firebase/auth");var isMergeableObject=function(e){return isNonNullObject(e)&&!isSpecial(e)};function isNonNullObject(e){return!!e&&"object"==typeof e}function isSpecial(e){var t=Object.prototype.toString.call(e);return"[object RegExp]"===t||"[object Date]"===t||isReactElement(e)}var canUseSymbol="function"==typeof Symbol&&Symbol.for,REACT_ELEMENT_TYPE=canUseSymbol?Symbol.for("react.element"):60103;function isReactElement(e){return e.$$typeof===REACT_ELEMENT_TYPE}function emptyTarget(e){return Array.isArray(e)?[]:{}}function cloneUnlessOtherwiseSpecified(e,t){return!1!==t.clone&&t.isMergeableObject(e)?deepmerge(emptyTarget(e),e,t):e}function defaultArrayMerge(e,t,r){return e.concat(t).map(function(e){return cloneUnlessOtherwiseSpecified(e,r)})}function mergeObject(e,t,r){var n={};return r.isMergeableObject(e)&&Object.keys(e).forEach(function(t){n[t]=cloneUnlessOtherwiseSpecified(e[t],r)}),Object.keys(t).forEach(function(o){r.isMergeableObject(t[o])&&e[o]?n[o]=deepmerge(e[o],t[o],r):n[o]=cloneUnlessOtherwiseSpecified(t[o],r)}),n}function deepmerge(e,t,r){(r=r||{}).arrayMerge=r.arrayMerge||defaultArrayMerge,r.isMergeableObject=r.isMergeableObject||isMergeableObject;var n=Array.isArray(t);return n===Array.isArray(e)?n?r.arrayMerge(e,t,r):mergeObject(e,t,r):cloneUnlessOtherwiseSpecified(t,r)}deepmerge.all=function(e,t){if(!Array.isArray(e))throw new Error("first argument should be an array");return e.reduce(function(e,r){return deepmerge(e,r,t)},{})};var deepmerge_1=deepmerge;function overwriteMerge(e,t,r){return t}function merge(e,t,r){return r&&r.arrayOverwrite?deepmerge_1(e,t,{arrayMerge:overwriteMerge}):deepmerge_1(e,t)}function syncHook(e,t,r,n,o,i){e()}merge.all=function(e,t){return t&&t.arrayOverwrite?deepmerge_1.all(e,{arrayMerge:overwriteMerge}):deepmerge_1.all(e)};var defaultConfig={moduleNameSpace:"firestore",docsStateProp:"",firestorePath:"",firestoreRefType:"collection",vuexUserPath:"",sync:{type:"2way",where:[],orderBy:[],defaultValues:{},added:syncHook,modified:syncHook,removed:syncHook},fetch:{docLimit:50},insert:{checkCondition:null,fillables:[],guard:[]},patch:{checkCondition:null,fillables:[],guard:[]},delete:{checkCondition:null}},initialState={syncStack:{updates:{},deletions:[],inserts:[],debounceTimer:null},retrievedFetchRefs:[],nextFetchRef:null,patching:!1,doneFetching:!1,stopPatchingTimeout:null},mutations={resetSyncStack:function(e){e.syncStack={updates:{},deletions:[],inserts:[],debounceTimer:null}},INSERT_DOC:function(e,t){"doc"!==e.firestoreRefType.toLowerCase()&&this._vm.$set(e[e.docsStateProp],t.id,t)},PATCH_DOC:function(e,t){var r=this;if("doc"===e.firestoreRefType.toLowerCase())return e.docsStateProp?void(e[e.docsStateProp]=merge(e[e.docsStateProp],t,{arrayOverwrite:!0})):Object.keys(t).forEach(function(n){var o=void 0===e[n]?t[n]:isWhat.isObject(e[n])&&isWhat.isObject(t[n])?merge(e[n],t[n],{arrayOverwrite:!0}):t[n];r._vm.$set(e,n,o)});var n=void 0===e[e.docsStateProp][t.id]?t:isWhat.isObject(e[e.docsStateProp][t.id])&&isWhat.isObject(t)?merge(e[e.docsStateProp][t.id],t,{arrayOverwrite:!0}):t;this._vm.$set(e[e.docsStateProp],t.id,n)},DELETE_DOC:function(e,t){"doc"!==e.firestoreRefType.toLowerCase()&&this._vm.$delete(e[e.docsStateProp],t)}};function iniMutations(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments[1],r=vuexEasyAccess.defaultMutations(t);return Object.assign({},r,mutations,e)}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)};function copyObj(e){var t=void 0;if("object"!=(void 0===e?"undefined":_typeof(e)))return e;if(!e)return e;if("[object Object]"!==Object.prototype.toString.call(e)||"[object Array]"!==Object.prototype.toString.call(e))return JSON.parse(JSON.stringify(e));if("[object Array]"===Object.prototype.toString.call(e)){t=[];for(var r=0,n=e.length;r<n;r++)t[r]=copyObj(e[r]);return t}for(var o in t={},e)e.hasOwnProperty(o)&&(t[o]=copyObj(e[o]));return t}function setDefaultValues(e,t){return merge(t,e,{arrayOverwrite:!0})}function startDebounce(e){var t=Date.now();return{done:new Promise(function(r,n){var o=setInterval(function(n){Date.now()-t>=e&&(clearInterval(o),r(!0))},10)}),refresh:function(){return t=Date.now()}}}var actions={patchDoc:function(e){var t=e.state,r=e.getters,n=(e.commit,e.dispatch),o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{ids:[],fields:[]},i=o.id,c=void 0===i?"":i,a=o.ids,s=void 0===a?[]:a,u=o.field,l=void 0===u?"":u,d=o.fields,f=void 0===d?[]:d;if(!isWhat.isArray(s)||!isWhat.isArray(f))return console.log("ids, fields need to be arrays");if(!isWhat.isString(l))return console.log("field needs to be a string");c&&s.push(c),l&&f.push(l);var h=r.prepareForPatch(s,f);return Object.keys(h).forEach(function(e){var r=t.syncStack.updates[e]?merge(t.syncStack.updates[e],h[e],{arrayOverwrite:!0}):h[e];t.syncStack.updates[e]=r}),n("handleSyncStackDebounce")},deleteDoc:function(e){var t=e.state,r=e.getters,n=e.commit,o=e.dispatch,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];isWhat.isArray(i)||(i=[i]);var c=r.prepareForDeletion(i);if(n("SET_SYNCSTACK.DELETIONS",t.syncStack.deletions.concat(c)),t.syncStack.deletions.length)return o("handleSyncStackDebounce")},insertDoc:function(e){var t=e.state,r=e.getters,n=e.commit,o=e.dispatch,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];isWhat.isArray(i)||(i=[i]);var c=r.prepareForInsert(i);return n("SET_SYNCSTACK.INSERTS",t.syncStack.inserts.concat(c)),o("handleSyncStackDebounce")},handleSyncStackDebounce:function(e){var t=e.state,r=e.commit,n=e.dispatch;if(!e.getters.signedIn)return!1;if(!t.syncStack.debounceTimer){var o=startDebounce(1e3);o.done.then(function(e){return n("batchSync")}),r("SET_SYNCSTACK.DEBOUNCETIMER",o)}t.syncStack.debounceTimer.refresh()},batchSync:function(e){var t=e.getters,r=e.commit,n=e.dispatch,o=e.state,i=t.collectionMode,c=t.dbRef,a=Firebase.firestore().batch(),s=0,u=copyObj(o.syncStack.updates),l=Object.keys(u).map(function(e){return{id:e,fields:u[e]}});if(l.length>=500){s=500;var d=l.slice(0,500),f=l.slice(500,-1);o.syncStack.updates=f.reduce(function(e,t){return e[t.id]=t,delete t.id,e},{}),l=d}else o.syncStack.updates={},s=l.length;l.forEach(function(e){var t=e.id,r=i?c.doc(t):c,n=e.fields;a.update(r,n)});var h=copyObj(o.syncStack.deletions);if(s>=500)h=[];else{var p=500-s,y=h.slice(0,p),g=h.slice(p,-1);r("SET_SYNCSTACK.DELETIONS",g),s+=y.length,h=y}h.forEach(function(e){var t=c.doc(e);a.delete(t)});var m=copyObj(o.syncStack.inserts);if(s>=500)m=[];else{var v=500-s,S=m.slice(0,v),b=m.slice(v,-1);r("SET_SYNCSTACK.INSERTS",b),s+=S.length,m=S}return m.forEach(function(e){var r=t.dbRef.doc(e.id);a.set(r,e)}),n("_startPatching"),r("SET_SYNCSTACK.DEBOUNCETIMER",null),new Promise(function(e,t){a.commit().then(function(t){return console.log("[batchSync] RESOLVED:",t,"\n          updates: ",Object.keys(l).length?l:{},"\n          deletions: ",h.length?h:[],"\n          inserts: ",m.length?m:[]),Object.keys(o.syncStack.updates).length+o.syncStack.deletions.length+o.syncStack.inserts.length&&n("batchSync"),n("_stopPatching"),e()}).catch(function(e){return r("SET_PATCHING","error"),r("SET_SYNCSTACK.DEBOUNCETIMER",null),t()})})},fetch:function(e){var t=e.state,r=e.getters,n=e.commit,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{whereFilters:[],orderBy:[]},i=o.whereFilters,c=void 0===i?[]:i,a=o.orderBy,s=void 0===a?[]:a;return new Promise(function(e,o){if(console.log("[fetch] starting"),!r.signedIn)return e();if(t.doneFetching)return console.log("done fetching"),e("fetchedAll");var i,a=void 0;t.nextFetchRef?a=t.nextFetchRef:(a=r.dbRef,c.forEach(function(e){var t;a=(t=a).where.apply(t,toConsumableArray(e))}),s.length&&(a=(i=a).orderBy.apply(i,toConsumableArray(s))));if(a=a.limit(t.fetch.docLimit),t.retrievedFetchRefs.includes(a))return console.log("Already retrieved this part."),e();a.get().then(function(r){var o=r.docs;if(0===o.length)return n("SET_DONEFETCHING",!0),e("fetchedAll");o.length<t.fetch.docLimit&&n("SET_DONEFETCHING",!0),n("PUSH_RETRIEVEDFETCHREFS",a),e(r);var i=o[o.length-1],c=a.startAfter(i);n("SET_NEXTFETCHREF",c)}).catch(function(e){return console.log(e),o(e)})})},serverUpdate:function(e,t){var r=e.commit,n=t.change,o=t.id,i=t.doc,c=void 0===i?{}:i;switch(c.id=o,n){case"added":r("INSERT_DOC",c);break;case"removed":r("DELETE_DOC",o);break;default:r("PATCH_DOC",c)}},openDBChannel:function(e){var t,r=e.getters,n=e.state,o=e.commit,i=e.dispatch,c=r.collectionMode,a=r.dbRef;"doc"!==n.firestoreRefType.toLowerCase()&&(n.sync.where.forEach(function(e){var t;a=(t=a).where.apply(t,toConsumableArray(e))}),n.sync.orderBy.length&&(a=(t=a).orderBy.apply(t,toConsumableArray(n.sync.orderBy))));function s(e,t,r,o){function c(){return i("serverUpdate",{change:e,id:t,doc:r})}e=e?e.type:"modified";var a=n.sync[e];a?a(c,this,t,r,o):c()}return new Promise(function(e,t){a.onSnapshot(function(t){var r=t.metadata.hasPendingWrites?"local":"server";if(!c){var o=setDefaultValues(t.data(),n.sync.defaultValues);return"local"===r?e():(s(null,null,o,r),e())}t.docChanges().forEach(function(t){if("local"===r&&("modified"===t.type||"removed"===t.type))return e();var o=t.doc.id,i="added"===t.type?setDefaultValues(t.doc.data(),n.sync.defaultValues):t.doc.data();return s(t,o,i,r),e()})},function(e){return o("SET_PATCHING","error"),t(e)})})},set:function(e,t){e.commit;var r=e.dispatch,n=e.getters,o=e.state;if(t)return n.collectionMode?t.id&&o[o.docsStateProp][t.id]?r("patch",t):r("insert",t):r("patch",t)},insert:function(e,t){var r=e.commit,n=e.dispatch,o=e.getters;if(t)return t.id||(t.id=o.dbRef.doc().id),r("INSERT_DOC",t),n("insertDoc",t)},patch:function(e,t){var r=e.commit,n=(e.state,e.dispatch),o=e.getters;if(t&&(t.id||!o.collectionMode))return r("PATCH_DOC",t),n("patchDoc",{id:t.id,fields:Object.keys(t)})},delete:function(e,t){var r=e.commit,n=e.dispatch;e.getters;return r("DELETE_DOC",t),n("deleteDoc",t)},_stopPatching:function(e){var t=e.state,r=e.commit;t.stopPatchingTimeout&&clearTimeout(t.stopPatchingTimeout),t.stopPatchingTimeout=setTimeout(function(e){r("SET_PATCHING",!1)},300)},_startPatching:function(e){var t=e.state,r=e.commit;t.stopPatchingTimeout&&clearTimeout(t.stopPatchingTimeout),r("SET_PATCHING",!0)}};function iniActions(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.assign({},actions,e)}function checkFillables(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];return isWhat.isObject(e)?(t.length&&Object.keys(e).forEach(function(r){t.includes(r)||delete e[r]}),r.forEach(function(t){delete e[t]}),e):e}var getters={signedIn:function(e,t,r,n){return null!==vuexEasyAccess.getDeepRef(r,e.vuexUserPath)},dbRef:function(e,t,r,n){if(!t.signedIn)return!1;var o=Firebase.auth().currentUser.uid,i=e.firestorePath.replace("{userId}",o);return"collection"===e.firestoreRefType.toLowerCase()?Firebase.firestore().collection(i):Firebase.firestore().doc(i)},storeRef:function(e,t,r){var n=e.docsStateProp?e.moduleNameSpace+"/"+e.docsStateProp:e.moduleNameSpace;return vuexEasyAccess.getDeepRef(r,n)},collectionMode:function(e,t,r){return"collection"===e.firestoreRefType.toLowerCase()},prepareForPatch:function(e,t,r,n){return function(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],o=t.collectionMode;return o||r.push("singleDoc"),r.reduce(function(r,i){var c=e.patch.checkCondition;if(c&&!c(i,n,t.storeRef))return r;var a={};return n.length?n.forEach(function(e){a[e]=o?t.storeRef[i][e]:t.storeRef[e]}):a=checkFillables(a=copyObj(o?t.storeRef[i]:t.storeRef),e.patch.fillables,e.patch.guard),a.updated_at=Firebase.firestore.FieldValue.serverTimestamp(),r[i]=a,r},{})}},prepareForDeletion:function(e,t,r,n){return function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).reduce(function(r,n){var o=e.delete.checkCondition;return o&&!o(n,t.storeRef)?r:(r.push(n),r)},[])}},prepareForInsert:function(e,t,r,n){return function(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return(r=copyObj(r)).reduce(function(r,o){var i=e.insert.checkCondition;return i&&!i(o,t.storeRef)?r:((o=checkFillables(o,e.insert.fillables,e.insert.guard)).created_at=Firebase.firestore.FieldValue.serverTimestamp(),o.created_by=n["user/id"],r.push(o),r)},[])}}};function iniGetters(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.assign({},getters,e)}function errorCheck(e){return["firestorePath","vuexUserPath"].forEach(function(e){return console.error("Missing "+e+" from your config!"),!1}),/(\.|\/)/.test(e.docsStateProp)?(console.error("docsStateProp must only include letters from [a-z]"),!1):!/\./.test(e.moduleNameSpace)||(console.error("moduleNameSpace must only include letters from [a-z] and forward slashes '/'"),!1)}var vuexBase={state:null,mutations:null,actions:null,getters:null};function iniModule(e){var t=merge(vuexBase,e,{arrayOverwrite:!0});if(errorCheck(t)){var r=t.state,n=t.mutations,o=t.actions,i=t.getters;delete t.state,delete t.mutations,delete t.actions,delete t.getters;var c={};return t.docsStateProp&&(c[t.docsStateProp]={}),{namespaced:!0,state:merge.all([initialState,defaultConfig,r,t,c],{arrayOverwrite:!0}),mutations:iniMutations(n,merge(initialState,r)),actions:iniActions(o),getters:iniGetters(i)}}}function createEasyFirestore(e){return function(t){isWhat.isArray(e)||(e=[e]),e.forEach(function(e){var r=vuexEasyAccess.getKeysFromPath(e.moduleNameSpace);t.registerModule(r,iniModule(e))}),t.setDoc=function(e,r){return t.dispatch(e+"/setDoc",r)},t.insert=function(e,r){return t.dispatch(e+"/insert",r)},t.patch=function(e,r){return t.dispatch(e+"/patch",r)},t.delete=function(e,r){return t.dispatch(e+"/delete",r)}}}module.exports=createEasyFirestore;
//# sourceMappingURL=index.cjs.min.js.map
